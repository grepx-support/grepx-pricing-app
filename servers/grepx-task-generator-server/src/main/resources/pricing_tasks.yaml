# Pricing Application Tasks Configuration
# ========================================
# This file defines all Celery tasks and Dagster assets for the pricing application

celery_tasks:
  # Data Download Tasks
  - name: pricing.download_ticker_data
    module_path: business-tasks.providers.storage
    function_name: download_and_store
    description: Download stock price data from Yahoo Finance and store in database
    tags: [pricing, ingestion, download]
    options:
      bind: false
      max_retries: 3
    retry_policy:
      max_retries: 3
      interval_start: 0
      interval_step: 0.5
    timeout: 600
    is_active: true

  # Indicator Calculation Tasks - All use calculate_indicator with indicator_type parameter
  - name: pricing.calculate_sma
    module_path: business-tasks.tasks.indicators.sma
    function_name: calculate
    description: Calculate Simple Moving Average indicator
    tags: [pricing, indicators, sma]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_ema
    module_path: business-tasks.tasks.indicators.ema
    function_name: calculate
    description: Calculate Exponential Moving Average indicator
    tags: [pricing, indicators, ema]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_rsi
    module_path: business-tasks.tasks.indicators.rsi
    function_name: calculate
    description: Calculate Relative Strength Index indicator
    tags: [pricing, indicators, rsi]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_macd
    module_path: business-tasks.tasks.indicators.macd
    function_name: calculate
    description: Calculate MACD indicator
    tags: [pricing, indicators, macd]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_bollinger_bands
    module_path: business-tasks.tasks.indicators.bollinger_bands
    function_name: calculate
    description: Calculate Bollinger Bands indicator
    tags: [pricing, indicators, bollinger]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_atr
    module_path: business-tasks.tasks.indicators.atr
    function_name: calculate
    description: Calculate Average True Range indicator
    tags: [pricing, indicators, atr]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_stochastic
    module_path: business-tasks.tasks.indicators.stochastic
    function_name: calculate
    description: Calculate Stochastic Oscillator indicator
    tags: [pricing, indicators, stochastic]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_adx
    module_path: business-tasks.tasks.indicators.adx
    function_name: calculate
    description: Calculate Average Directional Index indicator
    tags: [pricing, indicators, adx]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_obv
    module_path: business-tasks.tasks.indicators.obv
    function_name: calculate
    description: Calculate On-Balance Volume indicator
    tags: [pricing, indicators, obv]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_vwap
    module_path: business-tasks.tasks.indicators.vwap
    function_name: calculate
    description: Calculate Volume Weighted Average Price indicator
    tags: [pricing, indicators, vwap]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_cci
    module_path: business-tasks.tasks.indicators.cci
    function_name: calculate
    description: Calculate Commodity Channel Index indicator
    tags: [pricing, indicators, cci]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

  - name: pricing.calculate_williams_r
    module_path: business-tasks.tasks.indicators.williams_r
    function_name: calculate
    description: Calculate Williams %R indicator
    tags: [pricing, indicators, williams]
    options:
      bind: false
    retry_policy: {}
    timeout: 300
    is_active: true

assets:
  # Data Download Asset
  - name: download_stock_prices
    description: Download historical stock prices from Yahoo Finance
    group_name: pricing_ingestion
    asset_type: source
    celery_task_name: pricing.download_ticker_data
    dependencies: []
    config:
      ticker: AAPL
      period: 1y
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  # Indicator Assets
  - name: sma_indicator
    description: Calculate SMA for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_sma
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 20
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: ema_indicator
    description: Calculate EMA for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_ema
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 20
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: rsi_indicator
    description: Calculate RSI for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_rsi
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 14
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: macd_indicator
    description: Calculate MACD for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_macd
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      fast: 12
      slow: 26
      signal: 9
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: bollinger_bands_indicator
    description: Calculate Bollinger Bands for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_bollinger_bands
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 20
      std_dev: 2.0
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: atr_indicator
    description: Calculate ATR for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_atr
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 14
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: stochastic_indicator
    description: Calculate Stochastic Oscillator for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_stochastic
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 14
      smooth_k: 3
      smooth_d: 3
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: adx_indicator
    description: Calculate ADX for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_adx
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 14
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: obv_indicator
    description: Calculate OBV for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_obv
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: vwap_indicator
    description: Calculate VWAP for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_vwap
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: cci_indicator
    description: Calculate CCI for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_cci
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 20
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  - name: williams_r_indicator
    description: Calculate Williams %R for stock
    group_name: pricing_indicators
    asset_type: transformation
    celery_task_name: pricing.calculate_williams_r
    dependencies: [download_stock_prices]
    config:
      ticker: AAPL
      period: 14
    task_args: []
    task_kwargs: {}
    partition_type: null
    partition_config: {}
    is_active: true

  # Multi-ticker daily analysis
  - name: daily_pricing_analysis
    description: Daily pricing analysis by date partition
    group_name: pricing_analytics
    asset_type: partitioned
    celery_task_name: pricing.download_ticker_data
    dependencies: []
    config:
      tickers: [AAPL, MSFT, GOOG]
    task_args: []
    task_kwargs: {}
    partition_type: daily
    partition_config:
      start_date: "2024-01-01"
    is_active: true

resources:
  - name: pricing_database
    resource_type: database
    config:
      connection_string: "pricing_data.duckdb"
    is_active: true

schedules:
  - name: daily_price_download
    cron_schedule: "0 17 * * 1-5"  # 5 PM weekdays after market close
    target_assets: [download_stock_prices]
    config: {}
    is_active: true

  - name: indicator_calculation_schedule
    cron_schedule: "30 17 * * 1-5"  # 5:30 PM weekdays after price download
    target_assets: [sma_indicator, ema_indicator, rsi_indicator, macd_indicator, bollinger_bands_indicator, atr_indicator]
    config: {}
    is_active: true

sensors:
  - name: price_data_watcher
    sensor_type: file_watcher
    target_assets: [download_stock_prices]
    config:
      watch_directory: "./market_data_incoming"
    minimum_interval_seconds: 300
    is_active: false

  - name: indicator_refresh_monitor
    sensor_type: interval
    target_assets: [sma_indicator, ema_indicator, rsi_indicator]
    config:
      check_interval: 3600
    minimum_interval_seconds: 3600
    is_active: false

