# Apache Airflow Integration Configuration
# Defines how Celery tasks integrate with Airflow DAGs for ticker processing
# This replicates the functionality of ticker_tasks.yaml but for Apache Airflow

airflow_integrations:
  # Ticker Data Ingestion Integration
  - name: ticker_ingestion_integration
    description: "Integrate Celery ticker loading task with Airflow DAG"
    airflow_dag_id: "ticker_ingestion_pipeline"
    celery_task_name: "business-tasks.data.load_tickers"
    celery_module_path: "business-tasks.tasks.data.tickers"
    celery_function_name: "load_tickers"
    task_params:
      csv_file_path: "data/tickers.csv"
      date: "{{ ds }}"  # Use Airflow's execution date
      collection_name: "tickers"
    queue: "default"
    retry_policy:
      max_retries: 2
      interval_start: 0
      interval_step: 0.5
    timeout: 600
    is_active: true

  # Financial Data Processing Integration
  - name: financial_data_integration
    description: "Integrate Celery financial data download with Airflow DAG"
    airflow_dag_id: "financial_data_pipeline"
    celery_task_name: "business-tasks.fundamentals.download_financial_data"
    celery_module_path: "business-tasks.tasks.fundamentals.download"
    celery_function_name: "download_financial_data"
    task_params:
      year: 2023
      quarter: 4
      data_types: ["balance_sheet", "income_statement", "cash_flow"]
    queue: "default"
    retry_policy:
      max_retries: 2
      interval_start: 0
      interval_step: 0.5
    timeout: 1800
    is_active: true

  # Metrics Calculation Integration
  - name: metrics_calculation_integration
    description: "Integrate Celery metrics calculation with Airflow DAG"
    airflow_dag_id: "metrics_calculation_pipeline"
    celery_task_names:
      - "business-tasks.fundamentals.calculate_free_cash_flow"
      - "business-tasks.fundamentals.calculate_debt_to_equity"
      - "business-tasks.fundamentals.calculate_current_ratio"
      - "business-tasks.fundamentals.calculate_net_profit_margin"
      - "business-tasks.fundamentals.calculate_return_on_equity"
    task_params:
      year: 2023
      quarter: 4
    queue: "default"
    retry_policy:
      max_retries: 2
      interval_start: 0
      interval_step: 0.5
    timeout: 600
    is_active: true

# Celery Configuration for Apache Airflow Integration
celery_config:
  broker_url: "redis://localhost:6379/0"
  result_backend: "redis://localhost:6379/0"
  task_serializer: "json"
  accept_content: ["json"]
  result_serializer: "json"
  timezone: "UTC"
  enable_utc: true
  worker_prefetch_multiplier: 1
  task_acks_late: true

# MongoDB Connection Settings (matching your existing database.yaml)
mongodb_config:
  default_connection:
    host: "localhost"
    port: 27017
    username: "admin"
    password: "password123"
    auth_source: "admin"
    database_name: "ticker_database"

# Integration Mapping - Maps Airflow tasks to Celery tasks
task_mappings:
  ticker_ingestion:
    airflow_task_id: "ingest_tickers_from_csv"
    celery_task_ref: "business-tasks.data.load_tickers"
    execution_context: "sync"  # Synchronous execution within Airflow task
    
  financial_data_download:
    airflow_task_id: "download_financial_statements"
    celery_task_ref: "business-tasks.fundamentals.download_financial_data"
    execution_context: "sync"
    
  metrics_calculations:
    airflow_task_id: "calculate_*"  # Wildcard for all metric calculation tasks
    celery_task_ref: "business-tasks.fundamentals.calculate_*"
    execution_context: "sync"

# Environment Configuration
environment:
  PYTHONPATH: "/home/atchu/Work/grepx-pricing-app"
  PROJECT_ROOT: "/home/atchu/Work/grepx-pricing-app"
  GREPX_DATABASE_API_URL: "http://localhost:8000"
  REDIS_URL: "redis://localhost:6379/0"